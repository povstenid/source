{{define "content"}}
<h1>Dashboard</h1>

<section>
    <h2>Bridges</h2>
    {{if .Bridges}}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Subnet</th>
                <th>Gateway</th>
                <th>NAT</th>
                <th>DHCP</th>
                <th>Forwards</th>
            </tr>
        </thead>
        <tbody>
            {{range .Bridges}}
            <tr>
                <td>{{.Name}}</td>
                <td>{{.Subnet}}</td>
                <td>{{.GatewayIP}}</td>
                <td>
                    <form method="POST" action="/nat/toggle" style="display:inline">
                        <input type="hidden" name="bridge" value="{{.Name}}">
                        {{if .NATEnabled}}
                        <button type="submit" class="btn-on" title="Click to disable">ON</button>
                        {{else}}
                        <button type="submit" class="btn-off" title="Click to enable">OFF</button>
                        {{end}}
                    </form>
                </td>
                <td>
                    {{if .DHCP}}
                    <a href="/dhcp/edit/{{.Name}}">{{.DHCP.RangeStart}} - {{.DHCP.RangeEnd}}</a>
                    {{else}}
                    <a href="/dhcp/edit/{{.Name}}">disabled</a>
                    {{end}}
                </td>
                <td>{{len .Forwards}}</td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{else}}
    <p>No bridges configured. Edit <code>pnat.json</code> to add bridges.</p>
    {{end}}
</section>

<section>
    <h2>Create Bridge (Proxmox)</h2>
    <form method="POST" action="/bridges/add" class="form-inline">
        <label>Bridge Name (letters, numbers, _)
            <input type="text" name="name" placeholder="vmbr1" list="suggest-bridge-name" pattern="[A-Za-z][A-Za-z0-9_]{1,20}([:.][0-9]+)?" title="Allowed: letters, numbers, _, optional :N or .N suffix" required>
        </label>
        <label>Bridge Ports
            <select name="bridge_ports">
                <option value="">(none - internal)</option>
                {{range .UplinkPorts}}
                <option value="{{.Name}}">{{.Name}} ({{.Type}})</option>
                {{end}}
            </select>
        </label>
        <label>Subnet (CIDR)
            <input type="text" name="subnet" placeholder="10.10.10.0/24" list="suggest-subnet" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}/[0-9]{1,2}" title="IPv4 CIDR, e.g. 10.10.10.0/24" required>
        </label>
        <label>Gateway IP
            <input type="text" name="gateway_ip" placeholder="10.10.10.1" list="suggest-gateway" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address" required>
        </label>
        <label>
            <input type="checkbox" name="nat_enabled" value="1">
            Enable NAT
        </label>
        <label>
            <input type="checkbox" name="dhcp_enabled" value="1">
            Enable DHCP
        </label>
        <label>DHCP Range Start
            <input type="text" name="range_start" placeholder="10.10.10.100" list="suggest-range-start" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address">
        </label>
        <label>DHCP Range End
            <input type="text" name="range_end" placeholder="10.10.10.200" list="suggest-range-end" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address">
        </label>
        <label>Lease Time
            <input type="text" name="lease_time" placeholder="12h" list="suggest-lease-time">
        </label>
        <label>DNS1
            <input type="text" name="dns1" placeholder="1.1.1.1" list="suggest-dns" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address">
        </label>
        <label>DNS2
            <input type="text" name="dns2" placeholder="8.8.8.8" list="suggest-dns" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address">
        </label>
        <button type="submit">Create</button>
    </form>
    <datalist id="suggest-bridge-name">
        <option value="vmbr1">
        <option value="vmbr2">
        <option value="lan1_nat">
    </datalist>
    <datalist id="suggest-subnet">
        <option value="10.10.10.0/24">
        <option value="192.168.10.0/24">
        <option value="172.16.10.0/24">
    </datalist>
    <datalist id="suggest-gateway">
        <option value="10.10.10.1">
        <option value="192.168.10.1">
        <option value="172.16.10.1">
    </datalist>
</section>

<section>
    <h2>Proxmox Bridges</h2>
    {{if .ProxmoxBridges}}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>CIDR</th>
                <th>Ports</th>
                <th>Managed</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .ProxmoxBridges}}
            <tr>
                <td>{{.Name}}</td>
                <td>{{if .CIDR}}{{.CIDR}}{{else}}-{{end}}</td>
                <td>{{if .Ports}}{{.Ports}}{{else}}-{{end}}</td>
                <td>{{if .Managed}}yes{{else}}no{{end}}</td>
                <td>
                    {{if .Managed}}
                    <form method="POST" action="/bridges/detach" style="display:inline">
                        <input type="hidden" name="name" value="{{.Name}}">
                        <button type="submit" class="btn-danger btn-sm" onclick="return confirm('Detach this bridge from PNAT?')">Detach</button>
                    </form>
                    {{else if .HasCIDR}}
                    <em>use Attach form</em>
                    {{else}}
                    <em>no IP/CIDR</em>
                    {{end}}
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{else}}
    <p>Proxmox bridges not available (check API connection).</p>
    {{end}}
</section>

<section>
    <h2>Attach Existing Bridge</h2>
    {{if .AttachableBridges}}
    <form method="POST" action="/bridges/attach" class="form-inline">
        <label>Bridge
            <select name="name" required>
                {{range .AttachableBridges}}
                <option value="{{.Name}}">{{.Name}} ({{.CIDR}})</option>
                {{end}}
            </select>
        </label>
        <label>
            <input type="checkbox" name="nat_enabled" value="1">
            Enable NAT
        </label>
        <label>
            <input type="checkbox" name="dhcp_enabled" value="1">
            Enable DHCP
        </label>
        <label>DHCP Range Start
            <input type="text" name="range_start" placeholder="10.10.10.100" list="suggest-range-start" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address">
        </label>
        <label>DHCP Range End
            <input type="text" name="range_end" placeholder="10.10.10.200" list="suggest-range-end" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address">
        </label>
        <label>Lease Time
            <input type="text" name="lease_time" placeholder="12h" list="suggest-lease-time">
        </label>
        <label>DNS1
            <input type="text" name="dns1" placeholder="1.1.1.1" list="suggest-dns" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address">
        </label>
        <label>DNS2
            <input type="text" name="dns2" placeholder="8.8.8.8" list="suggest-dns" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address">
        </label>
        <button type="submit">Attach</button>
    </form>
    {{else}}
    <p>No attachable bridges found.</p>
    {{end}}
</section>

<datalist id="suggest-range-start">
    <option value="10.10.10.100">
    <option value="192.168.10.100">
    <option value="172.16.10.100">
</datalist>
<datalist id="suggest-range-end">
    <option value="10.10.10.200">
    <option value="192.168.10.200">
    <option value="172.16.10.200">
</datalist>
<datalist id="suggest-lease-time">
    <option value="12h">
    <option value="24h">
    <option value="1h">
</datalist>
<datalist id="suggest-dns">
    <option value="1.1.1.1">
    <option value="8.8.8.8">
    <option value="9.9.9.9">
</datalist>

<section>
    <h2>Virtual Machines</h2>
    {{if .VMViews}}
    <table>
        <thead>
            <tr>
                <th>VMID</th>
                <th>Name</th>
                <th>Type</th>
                <th>Status</th>
                <th>Networks</th>
                <th>IPs / DHCP</th>
                <th>Change Bridge</th>
            </tr>
        </thead>
        <tbody>
            {{range .VMViews}}
            {{$vm := .}}
            <tr>
                <td>{{.VMID}}</td>
                <td>{{.Name}}</td>
                <td>{{.Type}}</td>
                <td class="status-{{.Status}}">{{.Status}}</td>
                <td>
                    {{if .NICs}}
                        {{range .NICs}}
                            <div><code>{{.Key}}</code>: {{if .Bridge}}{{.Bridge}}{{else}}-{{end}} {{if .MAC}}(<code>{{.MAC}}</code>){{end}}</div>
                        {{end}}
                    {{else}}
                        <em>no NICs</em>
                    {{end}}
                </td>
                <td>
                    {{if .NICs}}
                        {{range .NICs}}
                            <div><code>{{.Key}}</code>:
                                {{if .IPs}}
                                    {{range .IPs}}<code>{{.}}</code> {{end}}
                                {{else}}
                                    -
                                {{end}}
                                {{if .LeaseIP}}
                                    <span>(lease: <code>{{.LeaseIP}}</code>{{if .LeaseHost}} {{.LeaseHost}}{{end}})</span>
                                {{end}}
                            </div>
                        {{end}}
                    {{else}}
                        -
                    {{end}}
                </td>
                <td>
                    {{if .NICs}}
                        {{range .NICs}}
                            {{$nic := .}}
                            <form method="POST" action="/vms/net/update" style="display:inline">
                                <input type="hidden" name="vmid" value="{{$vm.VMID}}">
                                <input type="hidden" name="type" value="{{$vm.Type}}">
                                <input type="hidden" name="net" value="{{$nic.Key}}">
                                <select name="bridge" required>
                                    {{range $.BridgeOptions}}
                                        <option value="{{.}}"{{if eq . $nic.Bridge}} selected{{end}}>{{.}}</option>
                                    {{end}}
                                </select>
                                <button type="submit" class="btn-sm">Apply</button>
                            </form>
                            <div></div>
                        {{end}}
                    {{else if eq .Type "qemu"}}
                        <form method="POST" action="/vms/net/update" style="display:inline">
                            <input type="hidden" name="vmid" value="{{.VMID}}">
                            <input type="hidden" name="type" value="{{.Type}}">
                            <input type="hidden" name="net" value="net0">
                            <select name="bridge" required>
                                {{range $.BridgeOptions}}
                                    <option value="{{.}}">{{.}}</option>
                                {{end}}
                            </select>
                            <button type="submit" class="btn-sm">Add net0</button>
                        </form>
                    {{else}}
                        <em>n/a</em>
                    {{end}}
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{else}}
    <p>No VMs found (check Proxmox API connection).</p>
    {{end}}
</section>

{{if .UsedIPs}}
<section>
    <h2>Used IPs (PNAT Bridges)</h2>
    <table>
        <thead>
            <tr>
                <th>Bridge</th>
                <th>Subnet</th>
                <th>Used</th>
            </tr>
        </thead>
        <tbody>
            {{range .UsedIPs}}
            <tr>
                <td>{{.Bridge}}</td>
                <td>{{.Subnet}}</td>
                <td>
                    {{if .IPs}}
                        {{range .IPs}}
                            <div><code>{{.IP}}</code> <span>({{.Source}}{{if .VMID}} vm={{.VMID}}{{end}}{{if .MAC}} mac={{.MAC}}{{end}})</span></div>
                        {{end}}
                    {{else}}
                        <em>none</em>
                    {{end}}
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</section>
{{end}}

<section>
    <h2>nftables Status</h2>
    <pre>{{.NFTStatus}}</pre>
</section>
{{end}}
