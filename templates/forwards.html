{{define "content"}}
<h1>Port Forwards</h1>

<section>
    <h2>Add Forward</h2>
    <form method="POST" action="/forwards/add" class="form-inline">
        <label>Bridge
            <select id="bridgeSelect" name="bridge" required>
                {{range .Bridges}}
                <option value="{{.Name}}">{{.Name}} ({{.Subnet}})</option>
                {{end}}
            </select>
        </label>
        <label>Protocol
            <select name="protocol">
                <option value="tcp">TCP</option>
                <option value="udp">UDP</option>
                <option value="tcp+udp">TCP+UDP</option>
            </select>
        </label>
        <label>External Port
            <input type="number" name="ext_port" min="1" max="65535" list="popular-ports" required>
        </label>
        <label>Internal IP
            <input type="text" id="internalIP" name="int_ip" placeholder="select bridge to get suggestions" list="" pattern="(?:[0-9]{1,3}[.]){3}[0-9]{1,3}" title="IPv4 address" required>
        </label>
        <label>Internal Port
            <input type="number" name="int_port" min="1" max="65535" list="popular-ports" required>
        </label>
        <label>Comment
            <input type="text" name="comment" placeholder="optional">
        </label>
        <button type="submit">Add</button>
    </form>
    <datalist id="popular-ports">
        <option value="22" label="SSH">
        <option value="80" label="HTTP">
        <option value="443" label="HTTPS">
        <option value="53" label="DNS">
        <option value="3389" label="RDP">
        <option value="5900" label="VNC">
        <option value="8006" label="Proxmox UI">
        <option value="8080" label="HTTP-alt">
        <option value="8443" label="HTTPS-alt">
        <option value="25565" label="Minecraft">
        <option value="27017" label="MongoDB">
        <option value="3306" label="MySQL">
        <option value="5432" label="PostgreSQL">
        <option value="6379" label="Redis">
    </datalist>

    {{range .BridgeIPLists}}
    <datalist id="intip_{{.Bridge}}">
        {{range .Options}}
        <option value="{{.IP}}" label="{{.Label}}">
        {{end}}
    </datalist>
    {{end}}

    <script>
        (function() {
            var bridgeSel = document.getElementById('bridgeSelect');
            var ipInput = document.getElementById('internalIP');
            if (!bridgeSel || !ipInput) return;

            function setList() {
                var b = bridgeSel.value || '';
                if (!b) {
                    ipInput.setAttribute('list', '');
                    return;
                }
                ipInput.setAttribute('list', 'intip_' + b);
                ipInput.placeholder = 'IP in ' + b;
            }

            bridgeSel.addEventListener('change', setList);
            setList();
        })();
    </script>
</section>

<section>
    <h2>Current Rules</h2>
    {{if .Forwards}}
    <table>
        <thead>
            <tr>
                <th>Bridge</th>
                <th>Protocol</th>
                <th>Ext Port</th>
                <th>Int IP:Port</th>
                <th>Comment</th>
                <th>Enabled</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .Forwards}}
            <tr>
                <td>{{.Bridge}}</td>
                <td>{{.Protocol}}</td>
                <td>{{.ExtPort}}</td>
                <td>{{.IntIP}}:{{.IntPort}}</td>
                <td>{{.Comment}}</td>
                <td>
                    <form method="POST" action="/forwards/toggle" style="display:inline">
                        <input type="hidden" name="id" value="{{.ID}}">
                        {{if .Enabled}}
                        <button type="submit" class="btn-on btn-sm">ON</button>
                        {{else}}
                        <button type="submit" class="btn-off btn-sm">OFF</button>
                        {{end}}
                    </form>
                </td>
                <td>
                    <form method="POST" action="/forwards/delete" style="display:inline">
                        <input type="hidden" name="id" value="{{.ID}}">
                        <button type="submit" class="btn-danger btn-sm" onclick="return confirm('Delete this forward?')">Delete</button>
                    </form>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{else}}
    <p>No port forwards configured.</p>
    {{end}}
</section>
{{end}}
